<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∏—Ä –ö–Ω–∏–≥ - –ö–æ—Ä–∑–∏–Ω–∞</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <script src="/static/js/bootstrap.min.js"></script>
    <style>
        .cart-item {
            border-bottom: 1px solid #dee2e6;
            padding: 15px 0;
        }
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .empty-cart {
            text-align: center;
            padding: 50px 0;
        }
    </style>
</head>
<body style="min-height: 100vh; display: flex; flex-direction: column;">
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container">
            <a class="navbar-brand" href="/">–ú–∏—Ä –ö–Ω–∏–≥</a>
            <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/products">–¢–æ–≤–∞—Ä—ã</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/products" id="adminLink" style="display: none;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/orders" id="adminOrdersLink" style="display: none;">–ó–∞–∫–∞–∑—ã</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/cart">–ö–æ—Ä–∑–∏–Ω–∞</a>
                    </li>
                </ul>
                
                <form class="d-flex me-2" role="search">
                        <input class="form-control me-2" type="search" placeholder="–ü–æ–∏—Å–∫ –∫–Ω–∏–≥..." id="searchInput">
                        <button class="btn btn-outline-success" type="button" onclick="searchProducts()">–ü–æ–∏—Å–∫</button>
                    </form>
                <div class="d-flex align-items-center">
                    <a class="btn btn-outline-primary d-flex align-items-center me-2" href="/cart">
                        üõí<span class="badge bg-primary ms-2" id="cartBadge">0</span>
                    </a>
                    
                   
                    
                    <!-- –ö–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
                    <div class="d-flex align-items-center" id="authButtons">
                        <div id="guestButtons">
                            <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#loginModal">
                                –í–æ–π—Ç–∏
                            </button>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">
                                –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                            </button>
                        </div>
                        <div id="userButtons" style="display: none;">
                            <span class="me-3">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <strong id="userName"></strong>!</span>
                            <button class="btn btn-outline-secondary" onclick="logout()">
                                –í—ã–π—Ç–∏
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞ -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">–í–æ–π—Ç–∏</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="registerName" class="form-label">–ò–º—è</label>
                            <input type="text" class="form-control" id="registerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="registerEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" class="form-control" id="registerPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container mt-4 flex-grow-1">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">–ö–æ—Ä–∑–∏–Ω–∞ –ø–æ–∫—É–ø–æ–∫</h1>
                
                <div id="cartContent">
                    <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–∑–∏–Ω—ã -->
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã...</p>
                    </div>
                </div>
                
                <div id="emptyCart" class="empty-cart" style="display: none;">
                    <div class="mb-4">
                        <h3>üòî –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h3>
                        <p class="text-muted">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑</p>
                    </div>
                    <a href="/products" class="btn btn-primary btn-lg">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–æ–≤–∞—Ä–∞–º</a>
                </div>
                
                <div id="cartSummary" class="card mt-4" style="display: none;">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>–ò—Ç–æ–≥–æ:</h5>
                                <div class="d-flex justify-content-between">
                                    <span>–¢–æ–≤–∞—Ä—ã:</span>
                                    <span id="subtotal">0 —Ä—É–±.</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                                    <span id="shipping">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between fw-bold fs-5">
                                    <span>–û–±—â–∞—è —Å—É–º–º–∞:</span>
                                    <span id="total">0 —Ä—É–±.</span>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex align-items-center justify-content-end">
                                <button class="btn btn-success btn-lg" onclick="checkout()">
                                    –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="footer bg-body-tertiary mt-5">
        <div class="container p-4">
            <div class="d-flex flex-column">
                <h3>–ú–∞–≥–∞–∑–∏–Ω "–ú–∏—Ä –ö–Ω–∏–≥"</h3>
                <span>–ê–¥—Ä–µ—Å: 456204, –ó–ª–∞—Ç–æ—É—Å—Ç, —É–ª. –®–∞–ø–æ—à–Ω–∏–∫–æ–≤–∞, 1–∞</span>
                <span>–¢–µ–ª–µ—Ñ–æ–Ω: <a href="tel:+73513671044">+73513671044</a></span>
            </div>
        </div>
    </footer>

    <script src="/static/js/cart.js"></script>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = null;
        let isAdmin = false;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                loginUser(email, password);
            });

            document.getElementById('registerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                registerUser(name, email, password);
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchProducts();
                }
            });
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/user');
                const result = await response.json();
                
                if (result.logged_in) {
                    currentUser = result.user;
                    isAdmin = result.user.is_admin;
                    updateUI();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
            }
        }

        // –í—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loginUser(email, password) {
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({email: email, password: password})
                });
                
                const result = await response.json();
                if (result.success) {
                    currentUser = result.user;
                    isAdmin = result.user.is_admin;
                    updateUI();
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                    loginModal.hide();
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('loginForm').reset();
                    
                    alert('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ' + result.user.name + '!');
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
            }
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function registerUser(name, email, password) {
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({name: name, email: email, password: password})
                });
                
                const result = await response.json();
                if (result.success) {
                    currentUser = result.user;
                    isAdmin = result.user.is_admin;
                    updateUI();
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    const registerModal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
                    registerModal.hide();
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('registerForm').reset();
                    
                    alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ' + name + '!');
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
            }
        }

        // –í—ã—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function logout() {
            try {
                const response = await fetch('/api/logout');
                const result = await response.json();
                
                if (result.success) {
                    currentUser = null;
                    isAdmin = false;
                    updateUI();
                    alert('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
                }
            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            const guestButtons = document.getElementById('guestButtons');
            const userButtons = document.getElementById('userButtons');
            const userName = document.getElementById('userName');
            const adminLink = document.getElementById('adminLink');
            const adminOrdersLink = document.getElementById('adminOrdersLink');
            
            if (currentUser) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                guestButtons.style.display = 'none';
                userButtons.style.display = 'block';
                userName.textContent = currentUser.name;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –∞–¥–º–∏–Ω–∫—É —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
                if (isAdmin) {
                    adminLink.style.display = 'block';
                    adminOrdersLink.style.display = 'block';
                } else {
                    adminLink.style.display = 'none';
                    adminOrdersLink.style.display = 'none';
                }
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≥–æ—Å—Ç—è
                guestButtons.style.display = 'block';
                userButtons.style.display = 'none';
                adminLink.style.display = 'none';
                adminOrdersLink.style.display = 'none';
            }
        }

        function searchProducts() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (searchTerm) {
                window.location.href = `/products?search=${encodeURIComponent(searchTerm)}`;
            } else {
                window.location.href = '/products';
            }
        }
    </script>
</body>
</html>